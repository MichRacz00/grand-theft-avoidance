<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Users</title>
    <link rel="stylesheet" href="css/systemadministrator.css">
    <link rel="stylesheet" href="css/store.css">
    <link rel="stylesheet" href="css/Sidebar.css">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
</head>

<body scroll = "no" style="overflow: hidden">
<!--SIDEBAR-->
<div class="sidebar">
    <div class = "nav_top">
        <div class = "logo">
            <i class='bx bxs-meteor'></i>
            <span id="comp_name">LOGO</span>
        </div>
        <div class = "Profile">
            <img src="images/store_manager.png" alt="avatar" id="avatar"/>
            <div class="name">
                <span id = "name">Firstname Lastname</span>
            </div>
            <div class="title">
                <span id = "title">System Administrator</span>
            </div>
        </div>
    </div>

    <ul class="nav_list">

        <!--Users-->
        <li class="selected-tab" onclick="location.href='systemadministrator.html'">
            <i class='bx bx-user' ></i>
            <span class="tab-description">Users</span>
        </li>
        <!--Stores-->
        <li class="unselected-tab" onclick="location.href='systemadminstore.html'">
            <i class='bx bx-shopping-bag' ></i>
            <span class="tab-description">Stores</span>
        </li>


        <hr/>
        <!--Setting-->
        <li class="unselected-tab">
            <i class='bx bx-cog' ></i>
            <span class="tab-description">Setting</span>
        </li>

        <!--Log out-->
        <li class="unselected-tab" onclick="location.href='login.html'">
            <i class='bx bx-log-out' ></i>
            <span class="tab-description">Log out</span>
        </li>
    </ul>
</div>

<div class="user-division">
    <div id = "header">
        <h1 id ="store_header">User Accounts</h1>
    </div>

    <div class = "nav-user-actions">
        <ul class = "navigate-actions">
            <li class="users" id = "disactive"> <a href = "systemadministrator.html">Users</a></li>
            <li class="new-user" id = "active"><a>New User</a></li>
        </ul>
    </div>

    <div id = "new-user">
        <p>Add new user</p>
        <input type="text" id="userid" name = userid placeholder = "Username">
        <input type="text" id="password" name = password placeholder = "Temporary password">

        <form>
            <input type="radio" id=1 name="permission" value="1">
            <label for="1">Store Manager</label><br>
            <input type="radio" id=2 name="permission" value="2">
            <label for="1">Division Manager</label><br>
            <input type="radio" id=3 name="permission" value="4">
            <label for="1">System Administrator</label><br>
        </form>

        <button id="add-user" class= "btn1">Add user</button>
    </div>
</div>


<script>
    let baseUri = "http://localhost:8080/GTA_VI/rest/";

    getToken();
    updateTable();

    function getToken() {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            let myObj;
            if (this.readyState === 4 && this.status === 200) {
                myObj = JSON.parse(this.responseText);
                if (JSON.stringify(myObj) === "false" || myObj.permission !== 3) {
                    window.location.href = "login.html";
                }
            }
        }
        let uri = baseUri + "login/getId?token=" + localStorage.getItem("token");
        xhr.open("GET", uri);
        xhr.send();
    }

    function getDetails(id) {
        xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200) {
                alert(this.responseText);
            }
        }
        var uri = baseUri + "users/" + JSON.stringify(id);
        xhr.open("GET", uri);
        xhr.send();
    }

    function addUser(){
        let login;
        let password;
        let permission;
        let xhr = new XMLHttpRequest();

        const rbs = document.querySelectorAll('input[name="permission"]');
        let selectedValue;
        for (const rb of rbs) {
            if (rb.checked) {
                selectedValue = rb.value;
                break;
            }
        }
        alert(selectedValue);
        var uri = baseUri + "login?login=" + login +"&password="
            + password + "&permission="+ permission;
        xhr.open("POST", uri);
        xhr.send();
    }

    document.getElementById("add-user").addEventListener("click", addUser);


    document.getElementById("add-user").addEventListener("click", createUser);

    function createUser() {
        let login = document.getElementById("userid").value;
        let password = document.getElementById("password").value;
        let permission = 1;

        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200) {
                if (this.responseText === "true") {
                    alert ("User successfully added.");
                    let temp = {"login": login, "permission": permission};
                    table.addRow(temp);
                } else {
                    alert ("This username is already taken.");
                }
            }
        }
        let uri = baseUri + "login?login=" + login + "&password=" + password + "&permission=" + permission;
        xhr.open("POST", uri);
        xhr.send();
    }

    function updateTable() {
        $( "#table" ).load(window.location.href + " #table" );
    }

</script>
</body>
</html>