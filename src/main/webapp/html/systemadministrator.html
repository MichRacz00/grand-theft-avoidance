<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Users</title>
    <link rel="stylesheet" href="css/systemadministrator.css">
<!--    <link rel="stylesheet" href="css/store.css">-->
    <link rel="stylesheet" href="css/Sidebar.css">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
</head>

<body>
<!--SIDEBAR-->
<div class="sidebar">
    <div class = "nav_top">
        <div class = "logo">
            <i class='bx bxs-meteor'></i>
            <span id="comp_name">LOGO</span>
        </div>
        <div class = "Profile">
            <img src="images/store_manager.png" alt="avatar" id="avatar"/>
            <div class="name">
                <span id = "name">Firstname Lastname</span>
            </div>
            <div class="title">
                <span id = "title">System Administrator</span>
            </div>
        </div>
    </div>

    <ul class="nav_list">

        <!--Users-->
        <li class="selected-tab" onclick="location.href='systemadminstrator.html'">
            <i class='bx bx-user' ></i>
            <span class="tab-description">Users</span>
        </li>
        <!--Stores-->
        <li class="unselected-tab" onclick="location.href='systemadminstore.html'" >
            <i class='bx bx-shopping-bag' ></i>
            <span class="tab-description">Stores</span>
        </li>

        <hr/>
        <!--Setting-->
        <li class="unselected-tab">
            <i class='bx bx-cog' ></i>
            <span class="tab-description">Setting</span>
        </li>

        <!--Log out-->
        <li class="unselected-tab" onclick="location.href='login.html'">
            <i class='bx bx-log-out' ></i>
            <span class="tab-description">Log out</span>
        </li>
    </ul>
</div>

<div class="user-division">
    <div id = "header">
        <span id ="store_header">User Accounts</span>
    </div>

    <div id = "table_buttons">
        <div id = "new-user-btn-canvas">
             <button id = "new-user-btn" onclick="openForm()">
                 <span>New User</span>
             </button>
        </div>
        <div  id = "table"></div>

        <div id = "buttons">
            <button id="download-csv" class= "btn1"> <i class="fa fa-download"></i> Download CSV</button>
            <button id="download-json" class= "btn2"> <i class="fa fa-download"></i> Download JSON</button>
            <button id="download-xlsx" class= "btn1"> <i class="fa fa-download"></i> Download XLSX</button>
        </div>
    </div>

    <div id = "new-user">
        <div id = "new-user-canvas">
            <span>Add new user</span>
            <div id = "credential_inputs">
                <input type="text" id="userid" name = userid placeholder = "Username">
                <input type="text" id="password" name = password placeholder = "Temporary password">
                <input type="text" id="storeid" name = storeid  placeholder = "Store id">

            </div>

            <form>
                <input type="radio" id=1 name="permission" value="1">
                <label for="1">Store Manager</label><br>
                <input type="radio" id=2 name="permission" value="2">
                <label for="1">Division Manager</label><br>
                <input type="radio" id=3 name="permission" value="4">
                <label for="1">System Administrator</label><br>
            </form>

            <button id="add-user" onclick="addUser()">Add user</button>
        </div>

    </div>

</div>

<script>


    var userFormOpened = false;
    function openForm(){
        if(!userFormOpened){
            var userForm = document.getElementById('new-user');
            var table = document.getElementById("table_buttons");
            table.style.transition = "marginLeft 0.7s";
            table.style.marginLeft = "7%";
            userForm.style.visibility = "visible";
            userFormOpened = true;
        }
    }

    function closeForm(){
        if(userFormOpened){
            var userForm = document.getElementById('new-user');
            var table = document.getElementById("table_buttons");
            table.style.transition = "marginLeft 0.7s";
            table.style.marginLeft = "16%";
            userForm.style.visibility = "hidden";
            userFormOpened = false;

        }
    }

    let table;
    let baseUri = "http://localhost:8080/GTA_VI/rest/";

    getToken();

    function getToken() {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            let myObj;
            if (this.readyState === 4 && this.status === 200) {
                myObj = JSON.parse(this.responseText);
                if (JSON.stringify(myObj) === "false" || myObj.permission !== 3) {
                    window.location.href = "login.html";
                }
            }
        }
        let uri =  baseUri + "login/getId?token=" + localStorage.getItem("token");
        xhr.open("GET", uri);
        xhr.send();
    }

    function makeTable() {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            var myObj;
            if (this.readyState === 4 && this.status === 200) {
                myObj = JSON.parse(this.responseText);
                let tableData = [];
                var position;
                for (const x in myObj) {

                    if (myObj[x].permission > 1) {
                        myObj[x].store = '-';
                    }

                    if(myObj[x].permission === 1){
                        myObj[x].permission = 'Store Manager';
                    }else if (myObj[x].permission === 2){
                        myObj[x].permission = 'Division Manager';
                    }else{
                        myObj[x].permission = 'System Administrator';
                    }
                    let temp = {"username": myObj[x].username, "permission": myObj[x].permission, "store": myObj[x].store};
                    tableData.push(temp);

                }

                var link = function(cell, formatterParams, onRendered){
                    return "<a href = \"javascript:deleteUser(" + JSON.stringify(cell.getRow().getData().username) + ")\"><i class='bx bxs-trash' ></i></a>";
                };
                table = new Tabulator("#table", {
                    data: tableData,
                    pagination: "local",
                    layout: "fitDataTable",
                    paginationSize: 10,
                    paginationSizeSelector: [10, 25, 50, 100, true],
                    selectable:true,
                    columns: [
                        {title: "Username", field: "username", headerSort:false,hozAlign: "center", width: 240},
                        {title: "Position", field: "permission", headerSort:false,hozAlign: "center", width: 240},
                        {title: "Store", field: "store", headerSort:false,hozAlign: "center", width: 240},
                        {formatter:link, headerSort:false, hozAlign: "center", width: 240}
                    ]
                });

                document.getElementById("download-csv").addEventListener("click", function(){
                    table.download("csv", "ArticleData.csv");
                });

                document.getElementById("download-json").addEventListener("click", function(){
                    table.download("json", "ArticleData.json");
                });

                document.getElementById("download-xlsx").addEventListener("click", function(){
                    table.download("xlsx", "ArticleData.xlsx", {sheetName:"My Data"});
                });

            }
        }
        xhr.open("GET", baseUri + "users",true);
        xhr.send();
    }

    makeTable();

    function deleteUser(username){
        console.log(username+ " Deleted");
    }




    document.getElementById("add-user").addEventListener("click", createUser);


    function getPermision(){
        var storeMan = document.getElementById("1");
        var divMan = document.getElementById("2");
        var systAdm = document.getElementById("3");
        if(storeMan.checked){
            return 1;
        } else if (divMan.checked){
            return 2;
        } else if (systAdm.checked){
            return 3;
        } else {
            return 0;
        }
    }

    function createUser() {
        let login = document.getElementById("userid").value;
        let password = document.getElementById("password").value;
        let store = document.getElementById("storeid").value;
        let permission = getPermision();

        if (login === "" || password === "" || store === "" || permission === 0){
            alert("Please fill out the form");
        }else{
            let xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if(this.readyState === 4 && this.status === 200) {
                    if (this.responseText === "true") {
                        alert ("User successfully added.");
                        closeForm();
                        if (permission > 1) {
                            store = '-';
                        }

                        if(permission === 1){
                            permission = 'Store Manager';
                        }else if (permission === 2){
                            permission = 'Division Manager';
                        }else{
                            permission = 'System Administrator';
                        }
                        let temp = {"username": login, "permission": permission, "store":store};
                        table.addRow(temp);
                    } else {
                        alert ("This username is already taken.");
                    }
                }
            }
            let uri = baseUri + "login?login=" + login + "&password=" + password + "&storeid ="+ store + "&permission=" + permission;
            xhr.open("POST", uri);
            xhr.send();
        }
    }

    function getDetails(id) {
        xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200) {
                alert(this.responseText);
            }
        }
        var uri =  baseUri + "users/" + JSON.stringify(id);
        xhr.open("GET", uri);
        xhr.send();
    }

</script>
</body>
</html>