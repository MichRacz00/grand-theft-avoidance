<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> Stores List </title>
  <link rel="stylesheet" href="css/systemadminstore.css">
  <link rel="stylesheet" href="css/store.css">
  <link rel="stylesheet" href="css/Sidebar.css">
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
</head>

<body scroll = "no" style="overflow: hidden">

<!--SIDEBAR-->
<div class="sidebar">
  <div class = "nav_top">
    <div class = "logo">
      <i class='bx bxs-meteor'></i>
      <span id="comp_name">LOGO</span>
    </div>
    <div class = "Profile">
      <img src="images/store_manager.png" alt="avatar" id="avatar"/>
      <div class="name">
        <span id = "name">Firstname Lastname</span>
      </div>
      <div class="title">
        <span id = "title">System Administrator</span>
      </div>
    </div>
  </div>

  <ul class="nav_list">

    <!--Users-->
    <li class="unselected-tab" onclick="location.href='systemadministrator.html'">
      <i class='bx bx-user' ></i>
      <span class="tab-description">Users</span>
    </li>
    <!--Stores-->
    <li class="selected-tab" onclick="location.href='systemadminstore.html'">
      <i class='bx bx-shopping-bag' ></i>
      <span class="tab-description">Stores</span>
    </li>


    <hr/>
    <!--Setting-->
    <li class="unselected-tab">
      <i class='bx bx-cog' ></i>
      <span class="tab-description">Setting</span>
    </li>

    <!--Log out-->
    <li class="unselected-tab" onclick="location.href='login.html'">
      <i class='bx bx-log-out' ></i>
      <span class="tab-description">Log out</span>
    </li>
  </ul>
</div>

<div class="store-division">
  <div id = "header">
    <h1 id ="store_header">Manage Stores</h1>
  </div>

  <div class = "nav-user-actions">
    <ul class = "navigate-actions">
      <li class="stores" id = "active"> <a>Stores</a></li>
      <li class="new-store" id = "disactive"><a href = "newstore.html">New Store</a></li>
    </ul>
  </div>

  <div id = "table_buttons">
    <div id = "new-store-btn-canvas">
      <button id = "new-store-btn" onclick="openForm()">
        <span>New User</span>
      </button>
    </div>
    <div  id = "table"></div>

    <div id = "buttons">
      <button id="download-csv" class= "btn1"> <i class="fa fa-download"></i> Download CSV</button>
      <button id="download-json" class= "btn2"> <i class="fa fa-download"></i> Download JSON</button>
      <button id="download-xlsx" class= "btn1"> <i class="fa fa-download"></i> Download XLSX</button>
    </div>
  </div>
</div>

<script>

  function addUser(){
    if(userFormOpened){
      var userForm = document.getElementById('new-store');
      var table = document.getElementById("table_buttons");

    }
  }
  let baseUri = "http://localhost:8080/GTA_VI/rest/";
  getToken();
  let table;



  function getToken() {
    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
      let myObj;
      if (this.readyState === 4 && this.status === 200) {
        myObj = JSON.parse(this.responseText);
        if (JSON.stringify(myObj) === "false" || myObj.permission !== 3) {
          window.location.href = "login.html";
        }
      }
    }
    let uri = baseUri + "login/getId?token=" + localStorage.getItem("token");
    xhr.open("GET", uri);
    xhr.send();
  }

  function makeTable() {
    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
      var myObj;
      if (this.readyState === 4 && this.status === 200) {
        myObj = JSON.parse(this.responseText);
        let tableData = [];
        for (const x in myObj) {
          if (myObj[x].permission > 1) {
            myObj[x].store = '-';
          }
          let temp = {"store": myObj[x].id, "location": myObj[x].latitude + " " + myObj[x].longitude };
          tableData.push(temp);
        }

        table = new Tabulator("#table", {
          data: tableData,
          pagination: "local",
          layout: "fitDataTable",
          paginationSize: 10,
          paginationSizeSelector: [10, 25, 50, 100, true],
          selectable:true,
          columns: [
            {title: "Store", field: "store"},
            {title: "Location", field: "location"},
          ]
        });

        document.getElementById("download-csv").addEventListener("click", function(){
          table.download("csv", "ArticleData.csv");
        });

        document.getElementById("download-json").addEventListener("click", function(){
          table.download("json", "ArticleData.json");
        });

        document.getElementById("download-xlsx").addEventListener("click", function(){
          table.download("xlsx", "ArticleData.xlsx", {sheetName:"My Data"});
        });

        document.getElementById("download-pdf").addEventListener("click", function(){
          table.download("pdf", "ArticleData.pdf", {
            orientation:"portrait", //set page orientation to portrait
            title:"Example Report", //add title to report
          });
        });
      }
    }
    xhr.open("GET", baseUri + "stores", true);
    xhr.send();
  }

  makeTable();

  function deleteStore(storeid){
    console.log(storeid+ " Deleted");
  }


  function addStore(){
    let store;
    let latitude;
    let longitude;
    let xhr = new XMLHttpRequest();

    var uri = baseUri + "stores/addstore?id=" + store +"&latitude="
            + latitude + "&longitude="+ longitude;
    xhr.open("POST", uri);
    xhr.send();
  }

  document.getElementById("add-store").addEventListener("click", addUser);


  document.getElementById("add-store").addEventListener("click", createUser);

  function createStore() {
    let store = document.getElementById("storeid").value;
    let latitude = document.getElementById("latitude").value;
    let longitude = document.getElementById("longitude").value;
    let location = latitude + " " + longitude;

    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
      if(this.readyState === 4 && this.status === 200) {
        if (this.responseText === "true") {
          alert ("Store successfully added.");
          let temp = {"store": store, "location": location};
          table.addRow(temp);
        } else {
          alert ("This store is already exists.");
        }
      }
    }
    var uri = baseUri + "stores/addstore?id=" + store +"&latitude="
            + latitude + "&longitude="+ longitude;
    xhr.send();
  }


  function getDetails(id) {
    xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
      if(this.readyState === 4 && this.status === 200) {
        alert(this.responseText);
      }
    }
    var uri = baseUri + "users/" + JSON.stringify(id);
    xhr.open("GET", uri);
    xhr.send();
  }


</script>
</script>
</body>
</html>